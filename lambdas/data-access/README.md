# MWS-Template-Lambda-Node

This repo provides a foundation for building and packaging Lambda functions for AWS written with NodeJS.

Here are some good Lambda references:

- https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html
- https://d1.awsstatic.com/whitepapers/serverless-architectures-with-aws-lambda.pdf

A configuration file is included in `config` - edit this to suit your needs, while being mindful that your Lambda function and execution role **must** have unique names. Customizing to the specific needs of each Lambda may require any number of policies to be attached to the execution role - simply add the neccessary policy arn values to the "AttachRolePolicies" list in the executionRole section of the config. Most of the values represented in the JSON document are mapped directly to props for the created resources; the options included in the sample config are not exhaustive - especially with regards to configuring a Lambda to run within a VPC. For a detailed overview, see [the official docs](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/Lambda.html#createFunction-property).

**notes**
    - there is currently no scripted mechanism for updating a function's configuration - running the update script will only replace the function code in AWS. If you need to make adjustments to the function's operational paramaters, or to the execution role, you can either destroy then re-create the function (probably not the best idea,) or manually adjust the neccessary parameters in the AWS console. Since we're not using Terraform to manage the Lambda and execution role, there's nothing stopping you from making changes on-the-fly.
    - before running any of `create`, `update`, `promote`, or `destroy` from your local machine, you will need to generate a federated access token with infosec's amazon_adfs repository (https://msstash.morningstar.com/projects/INFOSEC/repos/amazon_adfs)

## Build Setup

``` bash
# install dependencies
npm install

# build for production with minification
npm run build
```

## Deployment

Lambda functions are region-specific resources in AWS. Each script requires a region (such as us-east-1,) to be provided as the first argument.

```bash
# create a new function in AWS. Uploads the application bundle generated by `npm run build`.
npm run create <region>

# update function code in AWS (again, after `npm run build`)
npm run update <region>

# promote a function alias - dev is promoted to qa, qa to uat, and uat to prd. Promoting "dev" will additionally publish a new function version, since dev always points to "latest".
npm run promote <region> <env>

# destroy the function in AWS
npm run destroy <region>
```

## Testing

```bash
# run unit tests
npm run unit

# lint and run tests
npm test
```
